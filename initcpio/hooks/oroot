#!/bin/ash

run_hook() {
  if [ "${oroot}" ]; then
     if [ "$(echo $root | grep UUID)" ]; then
        rootdev=$(resolve_device "$root")
        root=$rootdev
        unset rootdev
     fi;
     fsck_root() {
       echo &>/dev/null
     }
     if [ "$cryptkey" ]; then
        keydev=$(resolve_device "${cryptkey%%:*}")
     fi;
     if [[ "${cryptdevice}" && "${oroot}" = "live" && "${cryptkey}" ]]; then
        echo "#!/bin/bash
              mkdir /run/orootkey;
              mount \"$keydev\" /run/orootkey;
              cryptsetup --key-file \"/run/orootkey${cryptkey##*:}\" open \"$resolved\" \"$cryptname\";
              umount /run/orootkey;
              mkdir /run/oroot;
              mount -o \$(awk '{if (\$2 == \"/\") {print \$4}}' /etc/fstab) \"$root\" /run/oroot || mount \"$root\" /run/oroot;
              btrfs subvolume snapshot -r / /oroot-snap;
              rsync -a --delete /oroot-snap/ /run/oroot --exclude bin --exclude boot --exclude dev--exclude lib --exclude lib64 --exclude mnt--exclude proc --exclude run --exclude sbin --exclude sys --exclude tmp --exclude usr/bin/overlay_flush;
              btrfs subvolume snapshot -r /run/oroot \"/run/oroot/snapshots/\$(date +%s)\";
              btrfs subvolume delete /oroot-snap;
              umount /run/oroot;
              rm -r /run/oroot;
              cryptsetup close \"$root\";
              " > /overlay_flush;
       elif [[ "${cryptdevice}" && "${oroot}" = "live" ]]; then
        echo "#!/bin/bash
              cryptsetup open \"$resolved\" \"$cryptname\";
              mkdir /run/oroot;
              mount -o \$(awk '{if (\$2 == \"/\") {print \$4}}' /etc/fstab) \"$root\" /run/oroot || mount \"$root\" /run/oroot;
              btrfs subvolume snapshot -r / /oroot-snap;
              rsync -a --delete /oroot-snap/ /run/oroot --exclude bin --exclude boot --exclude dev--exclude lib --exclude lib64 --exclude mnt--exclude proc --exclude run --exclude sbin --exclude sys --exclude tmp --exclude usr/bin/overlay_flush;
              btrfs subvolume snapshot -r /run/oroot \"/run/oroot/snapshots/\$(date +%s)\";
              btrfs subvolume delete /oroot-snap;
              umount /run/oroot;
              rm -r /run/oroot;
              cryptsetup close \"$root\";
              " > /overlay_flush;
       else
        echo "#!/bin/bash
              mkdir /run/oroot;
              mount -o \$(awk '{if (\$2 == \"/\") {print \$4}}' /etc/fstab) \"$root\" /run/oroot || mount \"$root\" /run/oroot;
              cd /;
              rsync -a --delete / /run/oroot --exclude bin --exclude boot --exclude dev--exclude lib --exclude lib64 --exclude mnt--exclude proc --exclude run --exclude sbin --exclude sys --exclude tmp --exclude usr/bin/overlay_flush;
              btrfs subvolume snapshot -r /run/oroot \"/run/oroot/snapshots/\$(date +%s)\";
              umount /run/oroot;
              rm -r /run/oroot;
              " > /overlay_flush;
     fi;
     chmod ug+x /overlay_flush
     poll_device "$root" 20;
     "$mount_handler" /lroot;
     if [ ! -b "/dev/zram0" ]; then
        modprobe zram num_devices=$(($(nproc)+2))
     fi;
     mem_size=$(free -m | awk '/Mem/ {print int($2)}');
     if [[ "${oroot}" = "compressed" || "${oroot}" = "live" ]]; then
        oroot_device=$(zramctl -f -s $(($mem_size*2))M -a lzo -t $(nproc))
        if [ "$quiet" ]; then
           mkfs.btrfs "$oroot_device" &>/dev/null
          else
           mkfs.btrfs "$oroot_device";
        fi;
        mount "$oroot_device" /troot;
      else
        mount troot -t tmpfs -o size=${mem_size}M /troot
     fi;
     unset mem_size;
     if [ "${oroot}" = "live" ]; then
        root_snap=$(ls /lroot/snapshots | sort -nr | head -1);
        if [ "$quiet" ]; then
           btrfs send "/lroot/snapshots/$root_snap" 2>/dev/null | btrfs receive /troot/ &>/dev/null;
           btrfs subvolume snapshot "/troot/$root_snap" "/troot/${root_snap}_root" &>/dev/null;

         else
           btrfs send "/lroot/snapshots/$root_snap" | btrfs receive /troot/;
           btrfs subvolume snapshot "/troot/$root_snap" "/troot/${root_snap}_root";
        fi;
        umount /lroot;
        umount /troot;
        export oroot_device;
        export cryptdevice;
        export root_snap;
        oroot_mount() {
          mount -o subvol="${root_snap}_root" "$oroot_device" "$1"
          mv /overlay_flush /new_root/usr/bin/
          }
        if [ "${cryptdevice}" ]; then
           cryptsetup close "$root";
        fi;
       else
        mkdir /troot/upper;
        mkdir /troot/work;
        oroot_mount() {
          mount oroot -t overlay -o lowerdir=/lroot,upperdir=/troot/upper,workdir=/troot/work "$1"
          mv /overlay_flush /new_root/usr/bin/
        }
     fi;
     mount_handler=oroot_mount
  fi;
}
