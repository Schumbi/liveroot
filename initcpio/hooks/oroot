#!/bin/ash

run_hook() {
  if [ "${oroot}" ]; then
     if [ "$(echo $root | grep UUID)" ]; then
        rootdev=$(resolve_device "$root")
        root=$rootdev
        unset rootdev
     fi;
     fsck_root() {
       echo &>/dev/null
     }
     if [ "${cryptdevice}" ]; then
        if [ "${oroot}" = "live" ]; then
           echo "#!/bin/bash
                 cryptsetup open \"$resolved\" \"$cryptname\";
                 mount -o \$(awk '/$cryptname/ && !/#/ {print \$4}' /etc/fstab) \"$root\" /mnt;
                 cd /;
                 rsync -a --delete --exclude /usr/bin/overlay_flush etc home opt root srv usr var /mnt/;
                 umount /mnt;
                 cryptsetup close \"$root\";
                " > /overlay_flush;
         else
           echo "#!/bin/bash
                mount -o \$(awk '/$cryptname/ && !/#/ {print \$4}' /etc/fstab) \"$root\" /mnt;
                cd /;
                rsync -a --delete --exclude /usr/bin/overlay_flush etc home opt root srv usr var /mnt/;
                umount /mnt;
                " > /overlay_flush;
        fi;
       else
        echo "#!/bin/bash
              mount \"$root\" /mnt;
              cd /;
              rsync -a --delete --exclude /usr/bin/overlay_flush etc home opt root srv usr var /mnt/;
              umount /mnt;
            " > /overlay_flush;
     fi;
     chmod ug+x /overlay_flush
     poll_device "$root" 20;
     "$mount_handler" /lroot;
     if [ -z "$(lsmod | grep zram | head -1)" ]; then
        modprobe zram num_devices=$(($(nproc)+2))
     fi;
     mem_size=$(free -m | awk '/Mem/ {print int($2)}');
     if [ "${quiet}" ]; then
        zramctl -f -s $(($mem_size/2))M -a lzo -t $(nproc) &>/dev/null
      else
        zramctl -f -s $(($mem_size/2))M -a lzo -t $(nproc)
     fi;
     if [[ "${oroot}" = "compressed" || "${oroot}" = "live" ]]; then
        if [ "${quiet}" ]; then
           zramctl -f -s $(($mem_size*2))M -a lzo -t $(nproc) &>/dev/null
           mkfs.ext2 /dev/zram1 &>/dev/null
         else
           zramctl -f -s $(($mem_size*2))M -a lzo -t $(nproc)
           mkfs.ext2 /dev/zram1
        fi;
        mount /dev/zram1 /troot
      elif [ "${oroot}" = "raw" ]; then
        mount troot -t tmpfs -o size=${mem_size}M /troot
     fi;
     unset mem_size;
     if [ "${quiet}" ]; then
        mkswap /dev/zram0 &>/dev/null
        swapon /dev/zram0 &>/devnull
      else
        mkswap /dev/zram0
        swapon /dev/zram0
     fi;
     if [ ! "${oroot}" = "live" ]; then
        mkdir /troot/upper;
        mkdir /troot/work;
        oroot_mount() {
          mount oroot -t overlay -o lowerdir=/lroot,upperdir=/troot/upper,workdir=/troot/work "$1"
          mv /overlay_flush /new_root/usr/bin/
        }
      else
        cp -a /lroot/* /troot/;
        umount /lroot;
        umount /troot;
        oroot_mount() {
          mount /dev/zram1 "$1"
          mv /overlay_flush /new_root/usr/bin/
          if [ "${cryptdevice}" ]; then
             cryptsetup close "$root";
          fi;
        }
     fi;
     mount_handler=oroot_mount
  fi;
}
