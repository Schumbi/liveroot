#!/bin/ash

run_hook() {
  if [ "${oroot}" ]; then
     $mount_handler /lroot
     modprobe zram num_devices=$(nproc)
     zramctl find $(free -m | awk '/Mem/ {print $2/2}')M lzo $(nproc)
     if [ "${oroot}" = "compressed" ]; then
        zramctl find $(free -m | awk '/Mem/ {print $2/2}')M lzo $(nproc)
        mkfs.ext2 /dev/zram1
        mount /dev/zram1 /troot
      elif [ "${oroot}" = "raw" ]; then
        mount troot -t tmpfs /troot
     fi;
     mkdir /troot/upper
     mkdir /troot/work
     mount oroot -t overlay -o lowerdir=/lroot,upperdir=/troot/upper,workdir=/troot/work /new_root
     mkswap /dev/zram0
     swapon /dev/zram0
     mount_handler="echo"
  fi;
}